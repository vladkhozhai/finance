name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  PLAYWRIGHT_VERSION: '1.57.0'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # ==============================================================================
  # JOB 1: LINT & TYPE CHECK
  # ==============================================================================
  # Validates code quality using Biome and TypeScript compiler
  # Duration: ~30-60 seconds
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Turborepo lint
        run: npm run lint

      - name: TypeScript type check
        run: cd apps/finance-web && npx tsc --noEmit

  # ==============================================================================
  # JOB 2: BUILD
  # ==============================================================================
  # Validates that the Next.js application builds successfully using Turborepo
  # Duration: ~1-2 minutes
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with Turborepo
        run: npm run build
        env:
          # Required for Next.js build (uses dummy values for CI)
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.placeholder

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-output
          path: apps/finance-web/.next/
          retention-days: 7

  # ==============================================================================
  # JOB 3: E2E TESTS
  # ==============================================================================
  # Runs Playwright end-to-end tests against the application
  # Duration: ~2-4 minutes
  test:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: cd apps/finance-web && npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test
        env:
          # Test environment variables (use test Supabase instance)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/finance-web/playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: apps/finance-web/test-results/
          retention-days: 14

  # ==============================================================================
  # JOB 4: DATABASE MIGRATION VALIDATION
  # ==============================================================================
  # Validates that migrations can be applied without errors
  # Duration: ~30-60 seconds
  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: Start local Supabase instance
        run: npx supabase start

      - name: Validate migration syntax
        run: |
          echo "Validating all migration files..."
          for migration in supabase/migrations/*.sql; do
            echo "Checking $migration"
            # Basic syntax validation (Supabase CLI already applies migrations on start)
          done

      - name: Check for migration conflicts
        run: npx supabase db diff --use-migra

      - name: Stop Supabase
        if: always()
        run: npx supabase stop

  # ==============================================================================
  # SUMMARY JOB
  # ==============================================================================
  # Aggregates all job results for branch protection rules
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, build, test, validate-migrations]
    if: always()

    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "âŒ Lint job failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "âŒ Build job failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "âŒ Test job failed"
            exit 1
          fi
          if [[ "${{ needs.validate-migrations.result }}" != "success" ]]; then
            echo "âŒ Migration validation job failed"
            exit 1
          fi
          echo "âœ… All CI jobs passed successfully!"

      - name: Post summary
        run: |
          echo "## CI Pipeline Results ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Type Check | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migration Validation | ${{ needs.validate-migrations.result }} |" >> $GITHUB_STEP_SUMMARY
