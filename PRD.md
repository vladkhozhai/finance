# Project Name: FinanceFlow
## 1. Загальний опис
Персональний веб-додаток для комплексного управління фінансами на Next.js та Supabase. Система дозволяє не тільки трекати витрати, а й гнучко класифікувати їх за допомогою тегів та вести бюджетне планування з візуалізацією прогресу витрат.

## 2. Технічний стек
- **Frontend:** Next.js 14+ (App Router), TypeScript, Tailwind CSS.
- **UI Components:** Shadcn/UI (база), Radix UI (примітиви), Lucide React (іконки).
- **Charts:** Recharts (для візуалізації бюджетів).
- **Backend/DB:** Supabase (PostgreSQL, Auth, Realtime).
- **Logic:** Server Actions для мутацій даних, RLS для безпеки.

## 3. Функціональні вимоги (MVP)

### 3.1. Категоризація та Тегування
- **Категорії (Categories):** Базова класифікація (наприклад: Їжа, Дім). Кожна транзакція має рівно одну категорію.
- **Теги (Tags):** Гнучкі мітки для деталізації (наприклад: #кава, #ашан, #подорож).
    - Користувач може створювати власні теги.
    - До однієї транзакції можна прикріпити *кілька* тегів.

### 3.2. Бюджетування (Budgeting)
- **Створення бюджетів:** Користувач може встановити грошовий ліміт на місяць для:
    - Конкретної категорії (наприклад, "Їжа": 5000 грн).
    - Конкретного тегу (наприклад, "#таксі": 2000 грн).
- **Моніторинг:** Відображення прогрес-барів: "Витрачено X із Y (Z% залишилось)".
- **Статус:** Візуальна індикація перевитрат (наприклад, червоний колір, якщо > 100%).

### 3.3. Транзакції
- Створення доходів та витрат.
- При створенні: вибір категорії (dropdown) та мульти-вибір тегів.
- Дата, сума, текстовий опис.

### 3.4. Дашборд та Аналітика
- Загальний баланс.
- Блок "Активні бюджети": список прогрес-барів по поточним лімітам на цей місяць.
- Кругова діаграма витрат за категоріями.

### 3.5. Мультивалютна Підтримка (Multi-Currency Support)
- **Управління платіжними методами:** ✅ COMPLETED (Card #19)
    - Кожен платіжний метод має: назву, валюту (ISO 4217), тип карти (дебетова/кредитна/готівка), колір.
    - Можливість позначити платіжний метод за замовчуванням для швидкого введення транзакцій.
    - Архівування/деактивація платіжних методів (м'який видалення для збереження історичних транзакцій).
- **Транзакції з прив'язкою до валюти:** ✅ COMPLETED (Card #20)
    - При створенні транзакції користувач вибирає платіжний метод.
    - Сума вводиться в рідній валюті платіжного методу.
    - Система автоматично конвертує суму в базову валюту користувача з використанням поточного обмінного курсу.
    - Зберігаються: оригінальна сума (native_amount), обмінний курс (exchange_rate), базова валюта (base_currency).
    - Історія транзакцій відображає як оригінальну суму, так і конвертовану суму в базовій валюті.
- **Управління обмінними курсами:** ✅ BACKEND COMPLETED (Card #21)
    - Автоматичне отримання курсів з зовнішнього API (exchangerate-api.com) - ✅ LIVE
    - Обмінний курс зберігається з кожною транзакцією для історичної точності - ✅ DONE (Card #20)
    - Кешування курсів на 24 години для мінімізації API-запитів - ✅ WORKING (20.2x faster)
    - Можливість ручного введення курсу у разі недоступності API - ⏸️ FRONTEND PENDING
    - Перегляд поточних курсів валют у налаштуваннях - ⏸️ FRONTEND PENDING
    - Автоматичне оновлення курсів кожні 24 години - ✅ WORKING
    - Ручне оновлення через /api/cron/refresh-rates - ✅ WORKING
    - Fallback до застарілих курсів при збої API - ✅ WORKING
    - Трикутна конвертація (UAH→EUR через USD) - ✅ WORKING
- **Мультивалютний Дашборд:** ✅ COMPLETED (Card #22)
    - Загальний баланс у базовій валюті (сума всіх платіжних методів після конвертації). ✅
    - Картки окремих платіжних методів з балансами у рідних валютах. ✅
    - Відображення конвертованих сум з підказкою про використаний обмінний курс. ✅
    - Можливість фільтрації транзакцій по платіжному методу. ✅
    - Діаграми витрат за категоріями у базовій валюті для уніфікованої аналітики. ✅
    - Візуальна індикація застарілих курсів (>24 години). ✅
    - Останні транзакції по кожному платіжному методу. ✅
    - Адаптивний дизайн для всіх пристроїв. ✅
- **Мультивалютне Бюджетування:** ✅ COMPLETED (Card #23)
    - Бюджети встановлюються в базовій валюті користувача. ✅
    - Розрахунок витраченої суми враховує конвертацію всіх транзакцій у базову валюту. ✅
    - Можливість фільтрації бюджету по конкретному платіжному методу. ✅
    - Деталізація витрат по платіжних методах/валютах при перегляді бюджету. ✅
    - Візуалізація розбивки по платіжних методах із кольоровими індикаторами. ✅
    - Показ відсотку внеску кожного платіжного методу в бюджет. ✅
    - Підтримка легаси-транзакцій без прив'язки до платіжного методу. ✅
    - Адаптивний дизайн з підтримкою мобільних пристроїв. ✅

## 4. Структура Бази Даних (Schema Design)

**1. profiles** (розширення стандартного auth.users)
- `id` (uuid, PK), `currency` (text).

**2. categories**
- `id` (uuid), `user_id`, `name`, `color`, `type` (expense/income).

**3. tags**
- `id` (uuid), `user_id`, `name` (unique per user).

**4. transactions**
- `id` (uuid), `user_id`, `category_id` (FK), `amount` (decimal), `date` (timestamp), `description` (text).

**5. transaction_tags** (Junction Table for Many-to-Many)
- `transaction_id` (FK), `tag_id` (FK).

**6. budgets**
- `id` (uuid), `user_id`.
- `category_id` (nullable FK) — якщо бюджет на категорію.
- `tag_id` (nullable FK) — якщо бюджет на тег.
- `amount` (decimal) — запланована сума.
- `period` (date/text) — місяць дії бюджету (наприклад '2023-10-01').
- *Constraint:* Має бути заповнено або category_id, або tag_id (але не обидва разом для простоти MVP).

**7. payment_methods** (для мультивалютної підтримки)
- `id` (uuid, PK), `user_id` (FK), `name` (text), `currency` (text, ISO 4217).
- `card_type` (text) — тип: 'debit', 'credit', 'cash', 'savings'.
- `color` (text) — візуальна ідентифікація картки.
- `is_default` (boolean) — чи є платіжний метод за замовчуванням.
- `is_active` (boolean) — активна/архівована картка.
- `created_at`, `updated_at` (timestamptz).

**8. exchange_rates** (кеш обмінних курсів)
- `id` (uuid, PK), `from_currency` (text), `to_currency` (text), `rate` (decimal), `date` (date).
- `source` (text) — джерело курсу (API назва).
- `created_at` (timestamptz).
- *Constraint:* UNIQUE(from_currency, to_currency, date).

**Зміни у transactions (для мультивалютності):**
- Додати: `payment_method_id` (nullable FK до payment_methods).
- Додати: `native_amount` (decimal) — сума в оригінальній валюті картки.
- Додати: `exchange_rate` (decimal) — курс на момент транзакції (до базової валюти).
- Додати: `base_currency` (text) — базова валюта користувача на момент транзакції.
- Поле `amount` залишається як конвертована сума у базову валюту для зворотної сумісності.

## 5. UI/UX Деталі
- **Budget Card:** Компонент картки, що показує назву категорії/тегу, суму ліміту, скільки витрачено (розраховується динамічно) і Progress Bar.
- **Tag Input:** Компонент типу "Combobox" або "Multi-select", який дозволяє вибрати існуючі теги або створити новий на льоту ("Create 'NewTag'").
- **Payment Method Card:** Компонент для відображення платіжного методу з балансом у рідній валюті та конвертованим балансом у базовій валюті, іконкою валюти, та індикатором за замовчуванням.
- **Currency Selector:** Dropdown для вибору платіжного методу при створенні транзакції, з відображенням символу валюти та назви картки.
- **Multi-Currency Dashboard:** Віджет для відображення загального балансу у базовій валюті та окремих карток по кожному платіжному методу з можливістю фільтрації транзакцій.
- **Exchange Rate Tooltip:** Підказка при наведенні на конвертовану суму, що показує оригінальну суму, використаний обмінний курс та дату конвертації.
